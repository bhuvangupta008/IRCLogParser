language: python
python:
  - "2.7"

cache:
  directories:
    - $HOME/.cache/pip
    - $HOME/virtualenv/python2.7.13/lib/python2.7/site-packages/
  before_cache:
    - rm -rf $HOME/virtualenv/python2.7.13/lib/python2.7/site-packages/codeclimate-test-reporter
    - rm -rf $HOME/virtualenv/python2.7.13/lib/python2.7/site-packages/coverage
    - rm -rf $HOME/virtualenv/python2.7.13/lib/python2.7/site-packages/IRCLogParser-1.0.0-py2.7.egg
    - rm -f $HOME/.cache/pip/log/debug.log

# command to install dependencies
install:
  - pip install -U pip wheel
  - pip install sphinx
  - ls /home/travis/virtualenv/python2.7.13/lib/python2.7/site-packages
  - python setup.py install
  - python -m nltk.downloader wordnet
  - pip install 'coverage>=4.0,<4.4'
  - pip install codeclimate-test-reporter
  - ls /home/travis/virtualenv/python2.7.13/lib/python2.7/site-packages

script:
  - coverage run --source=. -m unittest discover -s test/

after_success:
  - coverage report -m
  - codeclimate-test-reporter --file .coverage --token $CODECLIMATE_REPO_TOKEN

deploy:
  skip_cleanup: true
  provider: script
  script: bash script/doc_auto_deploy.sh
  on:
    branch: dev-tests

  provider: script
  script: bash script/profile.sh || echo "========bypass profiling failure============="
  on:
    branch: dev-tests

after_deploy:
    - rm -rf $HOME/virtualenv/python2.7.13/lib/python2.7/site-packages/codeclimate-test-reporter
    - rm -rf $HOME/virtualenv/python2.7.13/lib/python2.7/site-packages/coverage
    - rm -rf $HOME/virtualenv/python2.7.13/lib/python2.7/site-packages/IRCLogParser-1.0.0-py2.7.egg
    - rm -f $HOME/.cache/pip/log/debug.log

